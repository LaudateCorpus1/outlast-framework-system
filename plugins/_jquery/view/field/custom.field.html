<!-- A key/value object editor for custom fields -->
<div id='{{field.uid}}-fields'></div>
<input type="hidden" name="{{field.name}}" id="{{field.uid}}">
<a class="btn btn-mini btn-success" onclick="add_field_{{field.uid}}('', '');">New</a>

<script language="javascript">
    var custom_field_changes_{{field.uid}} = {add: [], remove: [], order: [] };

    function add_field_{{field.uid}}(key, val){
        // create field with JS
        var el = $("<div class='alert alert-info keyvalues'>" +
        "<div class='col-md-6'>" +
        "<select class='field col-md-6 col-sm-6 form-control {{field.uid}}-select' id='{{field.uid}}-select' name='{{field.name}}[key][]' placeholder='key' onchange='update_field_{{field.uid}}($(this).val());'>" +
        {% foreach field.customfields as cf %}
        "<option value='{{cf.id}}'>{{cf.name}}</option>" +
        {% endforeach %}
        "</select></div><div class='col-md-6'>" +
        " - <input class='field text input-small {{field.uid}}-text' id='{{field.uid}}-text' type='text' name='{{field.name}}[value][]' placeholder='value' value='"+val+"'> <a class='close' href='#delete' onclick=\"$(this).parents('div.alert').first().remove();\">&times;</a></div>" +
        "</div>");
        // append a new key-value field
        $('#{{field.uid}}-fields').append(el);
    }
    {% if field.value %}

        zaj.ready(function(){
            {% foreach field.value as val %}
            add_field_{{field.uid}}('{{forloop.key|escapejs}}', '{{val|escapejs}}');
            {% endforeach %}
        });
    {% endif %}

    $(document).on('change', '.{{field.uid}}-select, .{{field.uid}}-text', function(){
        update_field_{{field.uid}}();
    });

    update_field_{{field.uid}} = function(){
        var fieldvalues = [];

        $('.keyvalues').each(function(e){
            var keyvalues = {};
            var key = $(this).find('.{{field.uid}}-select').val();
            var value = $(this).find('.{{field.uid}}-text').val();
            keyvalues[key] = value;
            fieldvalues.push(keyvalues);
        })
        // Set input
        $('#{{field.uid}}').val(JSON.stringify(fieldvalues));
    }
</script>