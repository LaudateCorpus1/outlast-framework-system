{% lang 'system/fields' 'photos' %}
<!-- requires jquery! ONLY FOR A SINGLE PHOTO!!!! -->
<!-- jquery ui -->
<script language="JavaScript" src="{{baseurl}}system/js/jquery/jquery-ui-1.9.2/js/jquery-ui-1.9.2.custom.min.js" type="text/javascript"></script>
<!--[if lt IE 8]><script src="{{baseurl}}system/js/json2.js"></script><![endif]-->
<script language="JavaScript" src="{{baseurl}}system/js/plupload/plupload.full.js" type="text/javascript"></script>

<script>
	ofw.ready(function(){
		ofw.addMyPhotoPopover_{{field.uid}} = function(el, url){
			console.log(el);
			el.popover({toggle: 'popover', html: true, container: 'body', placement: 'top', content: "<a class='btn btn-primary' href='"+url+"' target='_blank'><span class='glyphicon glyphicon-zoom-in'></span></a> <a class='btn btn-danger' data-photo='"+el[0].id+"' onclick='upload_remove_{{field.uid}}(event);'><span data-photo='"+el[0].id+"' class='glyphicon glyphicon-trash'></span></a> <a style='margin-left: 10px;' data-photo='"+el[0].id+"' onclick='ofw.closeMyPhotoPopover(event)'><span data-photo='"+el[0].id+"' class='glyphicon glyphicon-remove'></span></a>" });
		};
		ofw.closeMyPhotoPopover = function(ev){
			$('#'+$(ev.target).attr('data-photo')).popover('hide');
		};
	});
</script>


<a id="{{field.uid}}-pickfiles" class="btn ofw-field-photo pickfiles" style="cursor: pointer;"><i class="icon-folder-open"></i> {{#system_field_picture_upload#}}</a>

<div id="{{field.uid}}-transferbar" role="progressbar" class="hidden progress progress-striped active">
  <div class="bar progress-bar" style="width: 0%;"></div>
</div>

<!--
<br/>
<p class="foto_upload_standard">Nem megy a fotófeltöltés? <a href="#goupload" onclick="window.open ('{{nwappurl}}page=feltoltes_standard&fielduid={{field.uid}}','mywindow','status=0,toolbar=0,location=0,menubar=0,resizable=1,scrollbars=1,height=300,width=400');">Kattints ide!</a></p>
-->
<div id="{{field.id}}-uploadbutton"></div>
<div id="{{field.id}}-errors"></div>
<div class="foto ofw-field-photo filelist" id="{{field.uid}}-filelist">
	{% if field.value %}
    <div class="col-sm-2" id="{{field.value.id}}" style="position: relative; cursor: pointer;">
		<img class="pull-left img-thumbnail img-responsive" src="{{field.value.normal}}" />
    </div>
    <script>ofw.ready(function(){ ofw.addMyPhotoPopover_{{field.uid}}($('#{{field.value.id}}'), '{{field.value.large}}', '{{field.uid}}'); })</script>
	{% endif %}

</div>
<input type="hidden" name="{{field.name}}" id="{{field.uid}}">
<div class="clearfix"></div>
<br/>


<script type="text/javascript">
    var file_upload_changes_{{field.uid}} = {add: [], remove: [] };
	
	// create uploader and list
		var uploader_{{field.uid}};
		var filelist_{{field.uid}};	
		
		// create objects
			var uploader_{{field.uid}} = new plupload.Uploader({
				runtimes : 'html5,flash,html4',
				browse_button : '{{field.uid}}-pickfiles',
				drop_element : '{{field.uid}}-filelist',
            {% if field.options.max_height %}
				max_file_size : '{{field.options.max_file_size|escapejs}}',
            {% endif %}
                url : '{% block upload_url %}{{baseurl}}system/plupload/upload/photo/{% endblock upload_url %}',
				flash_swf_url : '{{baseurl}}system/js/plupload/plupload.flash.swf'
			});
			var uploadergo_{{field.uid}} = function(){
				//console.log("Starting upload...");
				uploader_{{field.uid}}.start()
			}
			
		// Add uploader events		
			uploader_{{field.uid}}.bind('Init', function(up, params){
				//console.log("Uploader initialized. Runtime: " + params.runtime);
			});
			uploader_{{field.uid}}.bind('FilesAdded', function(up, files) {
				setTimeout("uploadergo_{{field.uid}}()", 800);
			});			
			uploader_{{field.uid}}.bind('UploadProgress', function(up, file) {
				$('#{{field.uid}}-transferbar div').css('width', file.percent + "%")
				$('#{{field.uid}}-transferbar').removeClass('hidden');
			});
			uploader_{{field.uid}}.bind('Error', function(up, err) {
				alert("{{#system_field_file_upload_error#|printf:field.options.max_file_size|escapejs}}");
				up.refresh(); // Reposition Flash/Silverlight
			});
			uploader_{{field.uid}}.bind('FileUploaded', function(up, file, result) {
				setTimeout(function() { $('#{{field.uid}}-transferbar').addClass('hidden'); }, 1000);

				var res = jQuery.parseJSON(result.response);
				//console.log(res);
				// check for error
					if(res.status == 'error'){
						ofw.alert(res.message);
					}
					else{
						uploader_update_{{field.uid}}(res);
					}
			});
			

			/**
			 * Expects an object as such:
			 *	res.height, res.width, res.id
			 **/
			uploader_update_{{field.uid}} = function(res){
				// Is it wide/tall enough?
					{% if field.options.min_height and field.options.min_width %}
						if(res.height < {{field.options.min_height|escapejs}} || res.width < {{field.options.min_width|escapejs}}) return alert("{{#system_field_picture_too_small#|printf:field.options.min_width|printf:field.options.min_height|escapejs}}");
					{% endif %}
					{% if field.options.max_height %}
					// check for height, if is > 0;
						var max_height = {{field.options.max_height|escapejs}} + 0;
						if(max_height && res.height > max_height) return alert("{{#system_field_picture_too_high#|printf:field.options.max_height|escapejs}}");
					{% endif %}
					{% if field.options.max_width %}
					// check for width, if is > 0;
						if(max_width && res.width > max_width) return alert("{{#system_field_picture_too_wide#|printf:field.options.max_width|escapejs}}");					
						var max_width = {{field.options.max_width|escapejs}} + 0;
					{% endif %}
				// Add my image
					var imgurl = '{{baseurl}}system/plupload/preview/?id='+res.id;
                    var el = $("<div class='col-sm-2' id='"+res.id+"' style='position: relative; cursor: pointer;'><img class='pull-left img-thumbnail img-responsive' src='"+imgurl+"'></div>");
					$('#{{field.uid}}-filelist').html(el);
                    ofw.addMyPhotoPopover_{{field.uid}}(el, imgurl);
                    // Remove from add value
                    file_upload_changes_{{field.uid}}.add = jQuery.grep(file_upload_changes_{{field.uid}}.add, function(value) { return value != id; });
                    // Set as my input value
                    file_upload_changes_{{field.uid}}.add.push(res.id);
                    $('#{{field.uid}}').val(JSON.stringify(file_upload_changes_{{field.uid}}));
			};

            /**
             * Update after remove
             * @param {object} ev The event which is passed when clicking on the delete element.
             **/
            upload_remove_{{field.uid}} = function(ev){
                var id = $(ev.target).attr('data-photo');
                var $photodiv = $('#'+id);
                // Turn off my popover
                $photodiv.popover('hide');
                // Remove my div
                $photodiv.remove();
                // Remove from add value
                file_upload_changes_{{field.uid}}.add  = '';
                // Update my remove value
                file_upload_changes_{{field.uid}}.remove.push(id);
                // Set input
                $('#{{field.uid}}').val(JSON.stringify(file_upload_changes_{{field.uid}}));
            };
			
		// Run init
			uploader_{{field.uid}}.init();
</script>