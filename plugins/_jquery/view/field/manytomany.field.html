<!-- Load up my requirements -->
{% lang 'system/fields' 'relationships' %}

<link rel="stylesheet" href="{{baseurl}}system/css/ext/select2/select2.min.css">

{% block relationship_input %}
<!-- Additional hidden input so that empty value is sent when nothing is selected -->
<input type="hidden" name="{{field.name}}[]">
{% endblock relationship_input %}

<!-- Display markup -->
<img id="{{field.uid}}-loader" src='{{baseurl}}system/img/assets/ajax-loader.gif'>
<select class="{% block relationship_class %}ofw-field-manytomany{% endblock relationship_class %} form-control hide" data-placeholder="{{#system_field_relationships_search#|escape}}" id="{{field.uid}}" name="{% block relationship_name %}{{field.name}}[]{% endblock %}" {% block relationship_multiple %}multiple{% endblock %}>
	{% block relationship_empty %}{% endblock relationship_empty %}
	{% if field.choices.total <= 50 %}
		<option value="" disabled>{{#system_field_relationships_search#|escape}}</option>
		{% foreach field.choices as choice %}
			<option value='{{choice.id}}'>{{choice.name|escape}}</option>
		{% endforeach %}
	{% endif %}
	{% block relationship_selected_values %}
		{% if field.value %}
			{% foreach field.value as sitem %}
				<option value="{{sitem.id}}">{{sitem.name|escape}}</option>
			{% endforeach %}
		{% endif %}
	{% endblock relationship_selected_values %}
</select>
<script>
	requirejs(["system/js/ofw-jquery", "system/js/ext/select2/select2.min"], function(select2){
		// Show it
		$('#{{field.uid}}').removeClass('hide');
		$('#{{field.uid}}-loader').addClass('hide');

		// Set selected items
		{% block relationship_selected_values_js %}
		{% if field.value %}
			var relationshipSelectedValues = [];
			{% foreach field.value as sitem %}
				relationshipSelectedValues.push("{{sitem.id}}");
            {% endfor %}
			$('#{{field.uid}}').val(relationshipSelectedValues).trigger('change');
        {% endif %}
		{% endblock relationship_selected_values_js %}

		// Init with select 2
		{% if field.choices.total <= 50 %}
			$('#{{field.uid}}').select2({
				allowClear: true,
				width: '100%'
			});
		{% elseif %}
			$('#{{field.uid}}').select2({
 				 allowClear: true,
				 ajax: {
					url: ofw.baseurl+"system/search/relation/",
					dataType: 'json',
					delay: 250,
					data: function (params) {
					  return {
						'query': params.term, // search term
						//'page': params.page,
						'class': '{{field.class_name}}',
						'field': '{{field.field_name}}'
					  };
					},
					processResults: function (data, params) {
					  // parse the results into the format expected by Select2
					  // since we are using custom formatting functions we do not need to
					  // alter the remote JSON data, except to indicate that infinite
					  // scrolling can be used
					  //params.page = params.page || 1;
					  return {
						results: data.data
						/**pagination: {
						// @todo fix pagination!
						  more: (params.page * 30) < data.data.length
						}**/
					  };
					},
					cache: true
				  },
				  width: '100%',
				  minimumInputLength: 1,
				  templateResult: function(node){
				  	if(node.name) return node.name;
				  	if(node.text) return node.text;

				  },
				  templateSelection: function(node){
				  	if(node.name) return node.name;
				  	if(node.text) return node.text;
				  }
			});

		{% endif %}
	});
</script>
<style>
	/** Fixes for Bootstrap modal **/
	.select2-close-mask{
	    z-index: 2099 !important;
	}
	.select2-dropdown{
		z-index: 3051 !important;
	}
</style>
