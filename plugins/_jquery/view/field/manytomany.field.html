<!-- Load up my requirements -->
{% lang 'system/fields' 'relationships' %}
<script src="{{baseurl}}system/js/chosen/chosen.jquery.min.js"></script>
<link rel="stylesheet" href="{{baseurl}}system/css/chosen/chosen.css">

<!-- Additional hidden input so that empty value is sent when nothing is selected -->
<input type="hidden" name="{{field.name}}[]">

<!-- Display markup -->
<select width="100%" data-placeholder="{{#system_field_relationships_search#|escape}}" id="{{field.uid}}" name="{{field.name}}[]" multiple>
	{% if field.choices.total <= 50 %}
		<option value="" disabled>{{#system_field_relationships_search#|escape}}</option>
		{% foreach field.choices as choice %}
			<option value='{{choice.id}}'>{{choice.name|escape}}</option>
		{% endforeach %}
	{% elseif %}
		{% if field.value %}
			{% foreach field.value as sitem %}
				<option value="{{sitem.id}}">{{sitem.name|escape}}</option>
			{% endforeach %}
		{% endif %}
	{% endif %}
</select>
<script>
	zaj.ready(function(){
        {% if field.value %}
            {% foreach field.value as sitem %}
                $('#{{field.uid}} option[value="{{sitem.id}}"]').attr('selected', 'selected');
            {% endfor %}
        {% endif %}
		$('#{{field.uid}}').chosen({width: '100%', inherit_select_classes: true, no_results_text: '{{#system_field_relationships_search#|escapejs}}'});

		{% if field.choices.total > 50 %}
			// Add search relation to field
			$('#{{field.uid}}').data('chosen').search_field.$zaj().search('system/search/relation/?class={{field.class_name}}&field={{field.name}}', function(res){
				// Decode json
					var rdata = JSON.parse(res);
				// Remove all unselected
					var $select = $('#{{field.uid}}');
					$select.find('option:not(:selected)').remove();
				// Add new ones
					for(var i = 0; i < rdata.data.length; i++){
						$select.append('<option value="'+rdata.data[i].id+'">'+rdata.data[i].name+'</option>');
					}
				// Update chosen
					$select.trigger('chosen:updated');
					$('#{{field.uid}}').data('chosen').search_field.val(rdata.query);
					$select.data('chosen').search_field.trigger('keyup.chosen');
			}, {pushstate_url: false, allow_empty_query: false});
		{% endif %}
	});
</script>
